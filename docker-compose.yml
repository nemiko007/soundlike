# docker-compose.yml

services:
  backend:
    build:
      context: ./backend # backendフォルダ内のDockerfileを使う
    ports:
      - "8080:8080" # ホストの8080ポートをコンテナの8080ポートにマッピング
    volumes:
      - ./backend/data:/root/data # データベースディレクトリを永続化
      - ./backend/uploads:/root/uploads # アップロードされたMP3ファイルを永続化
      - ./backend/firebase-service-account-key.json:/root/firebase-service-account-key.json:ro # Firebaseサービスアカウントキーを読み取り専用でマウント
    environment:
      GOOGLE_APPLICATION_CREDENTIALS: /root/firebase-service-account-key.json
      TZ: Asia/Tokyo # タイムゾーンを設定
    env_file:
      - .env # ホストの.envファイルを読み込んで環境変数としてコンテナに渡す
    restart: always # コンテナが停止した場合に常に再起動

  frontend:
    build:
      context: ./frontend # frontendフォルダ内のDockerfileを使う
      args:
        - PUBLIC_FIREBASE_API_KEY=${PUBLIC_FIREBASE_API_KEY}
        - PUBLIC_FIREBASE_AUTH_DOMAIN=${PUBLIC_FIREBASE_AUTH_DOMAIN}
        - PUBLIC_FIREBASE_PROJECT_ID=${PUBLIC_FIREBASE_PROJECT_ID}
        - PUBLIC_FIREBASE_STORAGE_BUCKET=${PUBLIC_FIREBASE_STORAGE_BUCKET}
        - PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
        - PUBLIC_FIREBASE_APP_ID=${PUBLIC_FIREBASE_APP_ID}
        - PUBLIC_FIREBASE_MEASUREMENT_ID=${PUBLIC_FIREBASE_MEASUREMENT_ID}
    ports:
      - "3000:80" # ホストの3000ポートをコンテナの80ポート（Nginx）にマッピング
    depends_on:
      - backend # バックエンドが起動してからフロントエンドを起動
    restart: always # コンテナが停止した場合に常に再起動
