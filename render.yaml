services:
  # --- バックエンドサービス (Go) ---
  - type: web
    name: backend
    env: docker
    # Dockerfileがある場所を指定
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    # ディスクの設定
    disks:
      # soundlike.db を永続化するためのディスク
      - name: soundlike-db
        mountPath: /root/soundlike.db
        sizeGB: 1 # 1GBで十分
      # アップロードされたファイルを永続化するためのディスク
      - name: uploads
        mountPath: /root/uploads
        sizeGB: 1
    secretFiles: # FirebaseのサービスアカウントキーをSecret Fileとしてマウント
      - key: firebase-service-account-key.json
        mountPath: /root/firebase-service-account-key.json
  # --- フロントエンドサービス (Nginx) ---
  - type: web
    name: frontend
    env: docker
    # Dockerfileがある場所を指定
    dockerfilePath: ./frontend/Dockerfile
    dockerContext: ./frontend
    # HTTPヘッダーとリライト/リダイレクトの設定
    rewrites:
      # APIリクエストをバックエンドに転送
      - source: /api/:path*
        destination: http://backend:8080/api/:path*
      # アップロードされたファイルへのリクエストをバックエンドに転送
      - source: /uploads/:path*
        destination: http://backend:8080/uploads/:path*
      # その他のリクエストは、React/Astroが処理できるようにindex.htmlにフォールバック (SPA対応)
      - source: /:path*
        destination: /index.html
